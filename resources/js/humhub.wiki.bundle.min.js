humhub.module("wiki",function(i,t,o){var e=t("ui.widget").Widget,n=t("event"),a=t("ui.view"),r=t("client"),c=[],e=e.extend();e.prototype.init=function(){o(window).off("scroll.wiki").on("scroll.wiki",function(){o.each(c,function(t,i){var e=o(window).scrollTop()+a.getContentTop()>i.$trigger.offset().top,n=!i.condition||i.condition.call();(e=e&&n)?i.$node.css({position:"sticky",top:a.getContentTop()+"px"}):i.$node.css({position:"relative",top:"0"})})})};i.export({Content:e,toAnchor:function(t){t=o("#"+o.escapeSelector(t.substr(1,t.length)));t.length&&(o("html, body").animate({scrollTop:t.offset().top-a.getContentTop()},200),history&&history.replaceState&&history.replaceState(null,null,"#"+t.attr("id")))},revertRevision:function(t){r.post(t).then(function(t){r.redirect(t.redirect),i.log.success("saved")}).catch(function(t){i.log.error(t,!0)})},actionDelete:function(t){r.pjax.post(t)},registerStickyElement:function(t,i,e){c.push({$node:t,$trigger:i,condition:e})},unload:function(){c=[],o(window).off("scroll.wiki"),n.off("humhub:content:afterMove.wiki")}})}),humhub.module("wiki.Page",function(t,i,e){i=i("ui.widget").Widget.extend();i.prototype.init=function(){var t=this;this.$.find("#wiki-page-richtext").on("afterInit",function(){t.$.fadeIn("slow")})},i.print=function(){window.print()},t.export=i}),humhub.module("wiki.Menu",function(t,i,a){var e=i("ui.widget").Widget,r=i("wiki"),n=i("event"),o=i("ui.view"),e=e.extend();e.prototype.init=function(){var t=this;o.isSmall()||r.registerStickyElement(this.$,a(".wiki-content"),function(){return t.$.height()<a(window).height()-o.getContentTop()}),a(".wiki-page-content").length&&(this.buildIndex(),this.initAnchor()),n.off("humhub:content:afterMove.wiki").on("humhub:content:afterMove.wiki",function(){t.$.find("#wiki_index").length&&t.$.find("#wiki_index").click()})},e.prototype.initAnchor=function(){window.location.hash&&r.toAnchor(window.location.hash),a(".wiki-content").find(".header-anchor").on("click",function(t){t.preventDefault(),r.toAnchor(a(this).attr("href"))})},e.prototype.buildIndex=function(){var n=a('<ul class="nav nav-pills nav-stacked">'),t=a('<li><a href="#"><i class="fa fa-list-ol"></i> '+r.text("pageindex")+"</li></a>").on("click",function(t){t.preventDefault();t=a(this).siblings(":not(.nav-divider)");t.first().is(":visible")?t.hide():t.show()});n.append(t);var o=!1;a("#wiki-page-richtext").children("h1,h2").each(function(){o=!0;var t=a(this).clone(),i=t.find(".header-anchor").clone();i.show(),t.find(".header-anchor").remove();var e=t.text();e&&e.trim().length&&(i.text(t.text()),e=a("<li>"),t=t.is("h2")?"wiki-menu-sub-section":"wiki-menu-section",e.addClass(t),i.prepend('<i class="fa fa-caret-right"></i>'),i.on("click",function(t){t.preventDefault(),r.toAnchor(i.attr("href"))}),e.append(i),n.append(e))}),o&&(n.append('<li class="nav-divider"></li>'),a(".wiki-menu-fixed").prepend(n))},t.export=e}),humhub.module("wiki.Form",function(t,i,e){var n=i("ui.widget").Widget,o=i("wiki"),a=i("ui.modal"),r=i("ui.additions"),n=n.extend();n.prototype.init=function(){var t=this;this.getRichtext().on("init",function(){o.registerStickyElement(t.getRichtextMenu(),t.getRichtext())}),setTimeout(function(){t.$.find(".regular-checkbox-container").each(function(){var t=e(this),i=t.find('[type="checkbox"][title]');i.length&&t.find("label").addClass("tt").attr("title",i.attr("title")),r.apply(t,"tooltip")},200),t.options.isCategory&&e("#wikipage-is_category").click(function(){var i=e(this);if(i.is(":not(:checked)"))return a.confirm({body:t.options.changeCategoryConfirm}).then(function(t){t||i.prop("checked",!0)});t.hideCategorySelect()}),t.hideCategorySelect()})},n.prototype.hideCategorySelect=function(){e("#wikipage-is_category").is(":not(:checked)")?e(".field-wikipage-parent_page_id").show():e(".field-wikipage-parent_page_id").hide()},n.prototype.getRichtextMenu=function(){return this.$menu||(this.$menu=this.$.find(".ProseMirror-menubar")),this.$menu},n.prototype.getRichtext=function(){return this.$richtext||(this.$richtext=this.$.find(".ProsemirrorEditor")),this.$richtext},t.export=n}),humhub.module("wiki.CategoryListView",function(n,t,o){var i=t("ui.widget").Widget,a=t("client"),e=t("ui.view"),i=i.extend();i.prototype.init=function(){this.$.find(".fa-caret-square-o-down, .fa-caret-square-o-right").on("click",function(){var i=o(this),e=i.parent().siblings(".wiki-page-list");e.slideToggle("fast",function(){var t=e.is(":visible")?"fa-caret-square-o-down":"fa-caret-square-o-right";i.removeClass("fa-caret-square-o-down fa-caret-square-o-right").addClass(t);t=i.closest(".wiki-category-list-item[data-page-id]").data("page-id");t&&a.get(n.config.updateFoldingStateUrl,{data:{categoryId:t,state:e.is(":visible")?0:1}})})}),this.$.sortable({delay:e.isSmall()?250:null,handle:".drag-icon",items:".wiki-category-list-item[data-page-id]",helper:"clone",update:o.proxy(this.dropItem,this)}),this.$.find(".wiki-page-list").sortable({delay:e.isSmall()?250:null,handle:".drag-icon",connectWith:".wiki-page-list:not(#category_list_view)",helper:"clone",update:o.proxy(this.dropItem,this)}),e.isNormal()&&this.$.find(".page-title, .page-category-title").hover(function(){o(this).find(".wiki-page-control:not(.drag-icon)").show()},function(){o(this).find(".wiki-page-control:not(.drag-icon)").hide()})},i.prototype.dropItem=function(t,i){var e=i.item,i={"ItemDrop[id]":e.data("page-id"),"ItemDrop[targetId]":e.is(".wiki-category-list-item")?null:e.closest(".wiki-category-list-item").data("page-id"),"ItemDrop[index]":e.index()};a.post(this.options.dropUrl,{data:i}).then(function(t){t.success||(e.closest(".category_list_view, .wiki-page-list").sortable("cancel"),n.log.error("",!0))}).catch(function(t){n.log.error(t,!0),e.closest(".category_list_view, .wiki-page-list").sortable("cancel")})},n.export=i}),humhub.module("wiki.linkExtension",function(r,t,c){var i=t("ui.richtext.prosemirror"),e=t("ui.widget").Widget,l=t("ui.modal"),s=t("client"),n=t("wiki"),o=i.api.plugin.markdown,a=i.api.menu,t=(i.api.commands,i.api.plugin),d=i.api.state.NodeSelection,h=function(n){n.schema.marks.wiki;var t={title:n.translate("Add or remove Wiki link"),icon:{width:32,height:32,path:"M30.212 7.3c0 0.1-0.031 0.194-0.094 0.281-0.063 0.081-0.131 0.125-0.212 0.125-0.625 0.063-1.137 0.263-1.531 0.6-0.4 0.338-0.806 0.994-1.225 1.95l-6.45 14.544c-0.044 0.137-0.163 0.2-0.356 0.2-0.15 0-0.269-0.069-0.356-0.2l-3.619-7.563-4.162 7.563c-0.088 0.137-0.2 0.2-0.356 0.2-0.188 0-0.306-0.069-0.369-0.2l-6.331-14.537c-0.394-0.9-0.813-1.531-1.25-1.887s-1.050-0.581-1.831-0.662c-0.069 0-0.131-0.037-0.188-0.106-0.063-0.069-0.087-0.15-0.087-0.244 0-0.237 0.069-0.356 0.2-0.356 0.562 0 1.156 0.025 1.775 0.075 0.575 0.050 1.112 0.075 1.619 0.075 0.513 0 1.125-0.025 1.825-0.075 0.731-0.050 1.381-0.075 1.95-0.075 0.137 0 0.2 0.119 0.2 0.356s-0.044 0.35-0.125 0.35c-0.563 0.044-1.012 0.188-1.338 0.431s-0.487 0.563-0.487 0.963c0 0.2 0.069 0.456 0.2 0.756l5.231 11.825 2.975-5.613-2.769-5.806c-0.5-1.037-0.906-1.706-1.225-2.006s-0.806-0.481-1.456-0.55c-0.063 0-0.113-0.037-0.169-0.106s-0.081-0.15-0.081-0.244c0-0.237 0.056-0.356 0.175-0.356 0.563 0 1.081 0.025 1.556 0.075 0.456 0.050 0.938 0.075 1.456 0.075 0.506 0 1.037-0.025 1.606-0.075 0.581-0.050 1.156-0.075 1.719-0.075 0.137 0 0.2 0.119 0.2 0.356s-0.038 0.35-0.125 0.35c-1.131 0.075-1.694 0.4-1.694 0.963 0 0.25 0.131 0.644 0.394 1.175l1.831 3.719 1.825-3.4c0.25-0.481 0.381-0.887 0.381-1.213 0-0.775-0.563-1.188-1.694-1.237-0.1 0-0.15-0.119-0.15-0.35 0-0.088 0.025-0.162 0.075-0.237s0.1-0.112 0.15-0.112c0.406 0 0.9 0.025 1.494 0.075 0.563 0.050 1.031 0.075 1.394 0.075 0.262 0 0.644-0.025 1.15-0.063 0.637-0.056 1.175-0.088 1.606-0.088 0.1 0 0.15 0.1 0.15 0.3 0 0.269-0.094 0.406-0.275 0.406-0.656 0.069-1.188 0.25-1.587 0.544s-0.9 0.963-1.5 2.013l-2.444 4.475 3.288 6.7 4.856-11.294c0.169-0.412 0.25-0.794 0.25-1.137 0-0.825-0.563-1.263-1.694-1.319-0.1 0-0.15-0.119-0.15-0.35 0-0.237 0.075-0.356 0.225-0.356 0.413 0 0.9 0.025 1.469 0.075 0.525 0.050 0.962 0.075 1.313 0.075 0.375 0 0.8-0.025 1.288-0.075 0.506-0.050 0.962-0.075 1.369-0.075 0.125 0 0.188 0.1 0.188 0.3z"},sortOrder:410,enable:function(t){return a.canInsert(t,n.schema.nodes.wiki)},run:function(t,i,e){t.selection instanceof d&&t.selection.node.type===n.schema.nodes.wiki?u(n,t,i,e,t.selection.node):p(n,t,i,e)}};return new a.MenuItem(t)},u=function(t,i,e,n,o){p(t,i,e,n,o.attrs)},p=function(e,t,i,n,o){c(".field-wikipagesearch-anchor").hide(),c("#wikipagesearch-anchor").empty();var a=l.get("#wikiLinkModal");c("#wikipagesearch-title").off("change.extract").on("change.extract",function(){c("#wikipagesearch-title").val()&&(c("#wikipagesearch-label").val(c("#wikipagesearch-title").select2("data")[0].text),s.get(r.config.extractTitleUrl,{data:{id:c("#wikipagesearch-title").val()}}).then(function(t){var i,e={};t.response&&t.response.length?(i=c("<option>").attr({value:""}).text(""),c("#wikipagesearch-anchor").append(i),t.response.forEach(function(t){var i=f(g(t),e),t=c("<option>").attr({value:i}).text(t);c("#wikipagesearch-anchor").append(t)}),o&&o.anchor&&c("#wikipagesearch-anchor").val(o.anchor),c(".field-wikipagesearch-anchor").show()):c(".field-wikipagesearch-anchor").hide()}).catch(function(t){r.log.error(t)}))}),(o&&o.wikiId?c("#wikipagesearch-title").val(o.wikiId):c("#wikipagesearch-title").val(1)).trigger("change"),o&&o.label?c("#wikipagesearch-label").val(o.label):c("#wikipagesearch-label").val(t.doc.cut(t.selection.from,t.selection.to).textContent),a.$.off("submitted").on("submitted",function(){var t=c("#wikipagesearch-title option:selected"),i=c("#wikipagesearch-label"),i={title:t.text(),wikiId:c("#wikipagesearch-title").val(),anchor:c("#wikipagesearch-anchor").val(),label:i.val()};a.close(),n.dispatch(n.state.tr.replaceSelectionWith(e.schema.nodes.wiki.createAndFill(i))),n.focus()}).show()},g=function(t){return encodeURIComponent(String(t).trim().toLowerCase().replace(/\s+/g,"-"))},f=function(t,i){for(var e=t,n=2;Object.prototype.hasOwnProperty.call(i,e);)e=t+"-"+n++;return i[e]=!0,e},n={id:"wiki",schema:{nodes:{wiki:{sortOrder:1001,inline:!0,group:"inline",marks:"em strong strikethrough",attrs:{wikiId:{default:""},anchor:{default:""},title:{default:""},label:{default:""}},inclusive:!1,parseDOM:[{tag:"span[data-wiki-page]",getAttrs:function(t){return{wikiId:t.getAttribute("data-wiki-page"),title:t.getAttribute("title"),label:t.textContent}}}],toDOM:function(t){return["span",{title:"#"===t.attrs.wikiId?r.text("pageNotFound"):t.attrs.title,"data-wiki-page":t.attrs.wikiId},t.attrs.label]},parseMarkdown:{node:"wiki",getAttrs:function(t){var i,e=t.attrGet("wikiId"),n="";return 0<=e.indexOf("#")&&(e=(i=e.split("#"))[0],n=i[1]),{label:t.attrGet("label"),title:t.attrGet("title"),wikiId:e,anchor:n}}},toMarkdown:function(t,i){var e="wiki:"+i.attrs.wikiId;t.write("["+t.esc(i.attrs.label)+"]("+t.esc(e)+' "'+i.attrs.anchor+'")')}}}},registerMarkdownIt:function(t){t.inline.ruler.before("link","wiki",o.createLinkExtension("wiki",{labelAttr:"label",hrefAttr:"wikiId",titleAttr:"title"})),t.renderer.rules.wiki=function(t,i){t=t[i];if(!t.attrGet("label"))return"";i="#"===t.attrGet("wikiId");return c("<div>").append(c("<a>").attr({href:t.attrGet("wikiId"),title:i?r.text("pageNotFound"):t.attrGet("title"),"data-wiki-page":i?"#":""}).text(t.attrGet("label"))).html()}},menu:function(t){return[{id:"wiki",node:"wiki",group:"marks",item:h(t)}]}};t.registerPlugin(n),t.registerPreset("wiki",{extend:"document",callback:function(t){t("wiki","wiki",{before:"link"})}});e=e.extend();r.initOnPjaxLoad=!0,r.export({SearchInput:e,setEditorLink:function(t){var i=l.get("#wikiLinkModal");i.$.trigger("submitted"),i.close()}})}),humhub.module("wiki.History",function(e,t,o){function a(t){o("input[type=radio][name=revision_"+r[t]+"]").prop("checked",!1)}var i=t("ui.widget").Widget,n=t("client"),i=i.extend(),r=[],c="input[type=radio][name^=revision_]";i.prototype.init=function(){o(c).each(function(t){r[t]=o(this).val(),t<2&&o(this).prop("checked",!0)});var i=0,e=1,n="top";this.$.on("click",c,function(){var t=o(c).index(o("[value="+o(this).val()+"]"));"top"===n&&i<t||e<t&&i<t?(a(e),n="bottom",e=t):(a(i),n="top",i=t)})},i.compare=function(){var t=e.config.wikiDiffUrl,i=1;o(c+":checked").each(function(){2<i||(t+=-1<t.indexOf("?")?"&":"?",t+="revision"+i+"="+o(this).val(),i++)}),n.pjax.redirect(t)},e.export=i});