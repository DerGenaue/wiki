humhub.module("wiki",function(t,e,r){var i=e("ui.widget").Widget,n=e("event"),o=e("ui.view"),a=e("client"),c=[],i=i.extend();i.prototype.init=function(){r(window).off("scroll.wiki").on("scroll.wiki",function(){r.each(c,function(e,t){var i=r(window).scrollTop()+o.getContentTop()>t.$trigger.offset().top,n=!t.condition||t.condition.call();(i=i&&n)?t.$node.css({position:"sticky",top:o.getContentTop()+"px"}):t.$node.css({position:"relative",top:"0"})})})};t.export({Content:i,toAnchor:function(e){e=r("#"+r.escapeSelector(e.substr(1,e.length)));e.length&&(r("html, body").animate({scrollTop:e.offset().top-o.getContentTop()},200),history&&history.replaceState&&history.replaceState(null,null,"#"+e.attr("id")))},revertRevision:function(e){a.post(e).then(function(e){a.redirect(e.redirect),t.log.success("saved")}).catch(function(e){t.log.error(e,!0)})},actionDelete:function(e){a.pjax.post(e)},registerStickyElement:function(e,t,i){c.push({$node:e,$trigger:t,condition:i})},unload:function(){c=[],r(window).off("scroll.wiki"),n.off("humhub:content:afterMove.wiki")}})}),humhub.module("wiki.Page",function(e,t,i){t=t("ui.widget").Widget.extend();t.prototype.init=function(){var e=this;this.$.find("#wiki-page-richtext").on("afterInit",function(){i(this).data("inited-richtext",!0),e.$.data("diff")?n(i(e.$.data("diff")).find("#wiki-page-richtext"),i(this)):e.$.fadeIn("slow")})},t.print=function(){window.print()};var n=function(i,n){var r=setInterval(function(){var e,t;i.length&&!i.data("inited-richtext")||(t=new RegExp('(<img .+?)data-ui-gallery=".+?"(.+?>)',"g"),e=i.length?i.html().replace(t,"$1$2"):"",t=n.length?n.html().replace(t,"$1$2"):"",n.html(htmldiff(e,t)),n.parent().fadeIn("slow"),clearInterval(r))},100)};e.export=t}),humhub.module("wiki.Menu",function(e,t,o){var i=t("ui.widget").Widget,a=t("wiki"),n=t("event"),r=t("ui.view"),i=i.extend();i.prototype.init=function(){var e=this;r.isSmall()||a.registerStickyElement(this.$,o(".wiki-content"),function(){return e.$.height()<o(window).height()-r.getContentTop()}),o(".wiki-page-content").length&&(this.buildIndex(),this.initAnchor()),n.off("humhub:content:afterMove.wiki").on("humhub:content:afterMove.wiki",function(){e.$.find("#wiki_index").length&&e.$.find("#wiki_index").click()})},i.prototype.initAnchor=function(){window.location.hash&&a.toAnchor(window.location.hash),o(".wiki-content").find(".header-anchor").on("click",function(e){e.preventDefault(),a.toAnchor(o(this).attr("href"))})},i.prototype.buildIndex=function(){var n=o('<ul class="nav nav-pills nav-stacked">'),e=o('<li><a href="#"><i class="fa fa-list-ol"></i> '+a.text("pageindex")+"</li></a>").on("click",function(e){e.preventDefault();e=o(this).siblings(":not(.nav-divider)");e.first().is(":visible")?e.hide():e.show()});n.append(e);var r=!1;o("#wiki-page-richtext").children("h1,h2").each(function(){r=!0;var e=o(this).clone(),t=e.find(".header-anchor").clone();t.show(),e.find(".header-anchor").remove();var i=e.text();i&&i.trim().length&&(t.text(e.text()),i=o("<li>"),e=e.is("h2")?"wiki-menu-sub-section":"wiki-menu-section",i.addClass(e),t.prepend('<i class="fa fa-caret-right"></i>'),t.on("click",function(e){e.preventDefault(),a.toAnchor(t.attr("href"))}),i.append(t),n.append(i))}),r&&(n.append('<li class="nav-divider"></li>'),o(".wiki-page-content").before(n),n.wrap('<div class="col-lg-3 col-md-3 col-sm-3 wiki-menu wiki-menu-top"></div>'))},e.export=i}),humhub.module("wiki.Form",function(e,t,i){var n=t("ui.widget").Widget,r=t("wiki"),o=t("ui.modal"),a=t("ui.additions"),n=n.extend();n.prototype.init=function(){var e=this;this.getRichtext().on("init",function(){r.registerStickyElement(e.getRichtextMenu(),e.getRichtext())}),setTimeout(function(){e.$.find(".regular-checkbox-container").each(function(){var e=i(this),t=e.find('[type="checkbox"][title]');t.length&&e.find("label").addClass("tt").attr("title",t.attr("title")),a.apply(e,"tooltip")},200),e.options.isCategory&&i("#wikipage-is_category").click(function(){var t=i(this);if(t.is(":not(:checked)"))return o.confirm({body:e.options.changeCategoryConfirm}).then(function(e){e||t.prop("checked",!0)});e.hideCategorySelect()}),e.hideCategorySelect()})},n.prototype.hideCategorySelect=function(){i("#wikipage-is_category").is(":not(:checked)")?i(".field-wikipage-parent_page_id").show():i(".field-wikipage-parent_page_id").hide()},n.prototype.getRichtextMenu=function(){return this.$menu||(this.$menu=this.$.find(".ProseMirror-menubar")),this.$menu},n.prototype.getRichtext=function(){return this.$richtext||(this.$richtext=this.$.find(".ProsemirrorEditor")),this.$richtext},n.submit=function(){i('form[data-ui-widget="wiki.Form"]').submit()},e.export=n}),humhub.module("wiki.CategoryListView",function(n,e,r){var t=e("ui.widget").Widget,o=e("client"),i=e("ui.view"),t=t.extend();t.prototype.init=function(){this.$.find(".fa-caret-square-o-down, .fa-caret-square-o-right").on("click",function(){var t=r(this),i=t.parent().siblings(".wiki-page-list");i.slideToggle("fast",function(){var e=i.is(":visible")?"fa-caret-square-o-down":"fa-caret-square-o-right";t.removeClass("fa-caret-square-o-down fa-caret-square-o-right").addClass(e);e=t.closest(".wiki-category-list-item[data-page-id]").data("page-id");e&&o.get(n.config.updateFoldingStateUrl,{data:{categoryId:e,state:i.is(":visible")?0:1}})})}),this.$.sortable({delay:i.isSmall()?250:null,handle:".drag-icon",items:".wiki-category-list-item[data-page-id]",helper:"clone",update:r.proxy(this.dropItem,this)}),this.$.find(".wiki-page-list").sortable({delay:i.isSmall()?250:null,handle:".drag-icon",connectWith:".wiki-page-list:not(#category_list_view)",helper:"clone",update:r.proxy(this.dropItem,this)}),i.isNormal()&&this.$.find(".page-title, .page-category-title").hover(function(){r(this).find(".wiki-page-control:not(.drag-icon)").show()},function(){r(this).find(".wiki-page-control:not(.drag-icon)").hide()})},t.prototype.dropItem=function(e,t){var i=t.item,t={"ItemDrop[id]":i.data("page-id"),"ItemDrop[targetId]":i.is(".wiki-category-list-item")?null:i.closest(".wiki-category-list-item").data("page-id"),"ItemDrop[index]":i.index()};o.post(this.options.dropUrl,{data:t}).then(function(e){e.success||(i.closest(".category_list_view, .wiki-page-list").sortable("cancel"),n.log.error("",!0))}).catch(function(e){n.log.error(e,!0),i.closest(".category_list_view, .wiki-page-list").sortable("cancel")})},n.export=t}),humhub.module("wiki.linkExtension",function(a,e,c){var t=e("ui.richtext.prosemirror"),i=e("ui.widget").Widget,s=e("ui.modal"),l=e("client"),n=e("wiki"),r=t.api.plugin.markdown,o=t.api.menu,e=(t.api.commands,t.api.plugin),d=t.api.state.NodeSelection,h=function(n){n.schema.marks.wiki;var e={title:n.translate("Add or remove Wiki link"),icon:{width:32,height:32,path:"M30.212 7.3c0 0.1-0.031 0.194-0.094 0.281-0.063 0.081-0.131 0.125-0.212 0.125-0.625 0.063-1.137 0.263-1.531 0.6-0.4 0.338-0.806 0.994-1.225 1.95l-6.45 14.544c-0.044 0.137-0.163 0.2-0.356 0.2-0.15 0-0.269-0.069-0.356-0.2l-3.619-7.563-4.162 7.563c-0.088 0.137-0.2 0.2-0.356 0.2-0.188 0-0.306-0.069-0.369-0.2l-6.331-14.537c-0.394-0.9-0.813-1.531-1.25-1.887s-1.050-0.581-1.831-0.662c-0.069 0-0.131-0.037-0.188-0.106-0.063-0.069-0.087-0.15-0.087-0.244 0-0.237 0.069-0.356 0.2-0.356 0.562 0 1.156 0.025 1.775 0.075 0.575 0.050 1.112 0.075 1.619 0.075 0.513 0 1.125-0.025 1.825-0.075 0.731-0.050 1.381-0.075 1.95-0.075 0.137 0 0.2 0.119 0.2 0.356s-0.044 0.35-0.125 0.35c-0.563 0.044-1.012 0.188-1.338 0.431s-0.487 0.563-0.487 0.963c0 0.2 0.069 0.456 0.2 0.756l5.231 11.825 2.975-5.613-2.769-5.806c-0.5-1.037-0.906-1.706-1.225-2.006s-0.806-0.481-1.456-0.55c-0.063 0-0.113-0.037-0.169-0.106s-0.081-0.15-0.081-0.244c0-0.237 0.056-0.356 0.175-0.356 0.563 0 1.081 0.025 1.556 0.075 0.456 0.050 0.938 0.075 1.456 0.075 0.506 0 1.037-0.025 1.606-0.075 0.581-0.050 1.156-0.075 1.719-0.075 0.137 0 0.2 0.119 0.2 0.356s-0.038 0.35-0.125 0.35c-1.131 0.075-1.694 0.4-1.694 0.963 0 0.25 0.131 0.644 0.394 1.175l1.831 3.719 1.825-3.4c0.25-0.481 0.381-0.887 0.381-1.213 0-0.775-0.563-1.188-1.694-1.237-0.1 0-0.15-0.119-0.15-0.35 0-0.088 0.025-0.162 0.075-0.237s0.1-0.112 0.15-0.112c0.406 0 0.9 0.025 1.494 0.075 0.563 0.050 1.031 0.075 1.394 0.075 0.262 0 0.644-0.025 1.15-0.063 0.637-0.056 1.175-0.088 1.606-0.088 0.1 0 0.15 0.1 0.15 0.3 0 0.269-0.094 0.406-0.275 0.406-0.656 0.069-1.188 0.25-1.587 0.544s-0.9 0.963-1.5 2.013l-2.444 4.475 3.288 6.7 4.856-11.294c0.169-0.412 0.25-0.794 0.25-1.137 0-0.825-0.563-1.263-1.694-1.319-0.1 0-0.15-0.119-0.15-0.35 0-0.237 0.075-0.356 0.225-0.356 0.413 0 0.9 0.025 1.469 0.075 0.525 0.050 0.962 0.075 1.313 0.075 0.375 0 0.8-0.025 1.288-0.075 0.506-0.050 0.962-0.075 1.369-0.075 0.125 0 0.188 0.1 0.188 0.3z"},sortOrder:410,enable:function(e){return o.canInsert(e,n.schema.nodes.wiki)},run:function(e,t,i){e.selection instanceof d&&e.selection.node.type===n.schema.nodes.wiki?u(n,e,t,i,e.selection.node):f(n,e,t,i)}};return new o.MenuItem(e)},u=function(e,t,i,n,r){f(e,t,i,n,r.attrs)},f=function(i,e,t,n,r){c(".field-wikipagesearch-anchor").hide(),c("#wikipagesearch-anchor").empty();var o=s.get("#wikiLinkModal");c("#wikipagesearch-title").off("change.extract").on("change.extract",function(){c("#wikipagesearch-title").val()&&(c("#wikipagesearch-label").val(c("#wikipagesearch-title").select2("data")[0].text),l.get(a.config.extractTitleUrl,{data:{id:c("#wikipagesearch-title").val()}}).then(function(e){var t,i={};e.response&&e.response.length?(t=c("<option>").attr({value:""}).text(""),c("#wikipagesearch-anchor").append(t),e.response.forEach(function(e){var t=g(p(e),i),e=c("<option>").attr({value:t}).text(e);c("#wikipagesearch-anchor").append(e)}),r&&r.anchor&&c("#wikipagesearch-anchor").val(r.anchor),c(".field-wikipagesearch-anchor").show()):c(".field-wikipagesearch-anchor").hide()}).catch(function(e){a.log.error(e)}))}),(r&&r.wikiId?c("#wikipagesearch-title").val(r.wikiId):c("#wikipagesearch-title").val(1)).trigger("change"),r&&r.label?c("#wikipagesearch-label").val(r.label):c("#wikipagesearch-label").val(e.doc.cut(e.selection.from,e.selection.to).textContent),o.$.off("submitted").on("submitted",function(){var e=c("#wikipagesearch-title option:selected"),t=c("#wikipagesearch-label"),t={title:e.text(),wikiId:c("#wikipagesearch-title").val(),anchor:c("#wikipagesearch-anchor").val(),label:t.val()};o.close(),n.dispatch(n.state.tr.replaceSelectionWith(i.schema.nodes.wiki.createAndFill(t))),n.focus()}).show()},p=function(e){return encodeURIComponent(String(e).trim().toLowerCase().replace(/\s+/g,"-"))},g=function(e,t){for(var i=e,n=2;Object.prototype.hasOwnProperty.call(t,i);)i=e+"-"+n++;return t[i]=!0,i},n={id:"wiki",schema:{nodes:{wiki:{sortOrder:1001,inline:!0,group:"inline",marks:"em strong strikethrough",attrs:{wikiId:{default:""},anchor:{default:""},title:{default:""},label:{default:""}},inclusive:!1,parseDOM:[{tag:"span[data-wiki-page]",getAttrs:function(e){return{wikiId:e.getAttribute("data-wiki-page"),title:e.getAttribute("title"),label:e.textContent}}}],toDOM:function(e){return["span",{title:"#"===e.attrs.wikiId?a.text("pageNotFound"):e.attrs.title,"data-wiki-page":e.attrs.wikiId},e.attrs.label]},parseMarkdown:{node:"wiki",getAttrs:function(e){var t,i=e.attrGet("wikiId"),n="";return 0<=i.indexOf("#")&&(i=(t=i.split("#"))[0],n=t[1]),{label:e.attrGet("label"),title:e.attrGet("title"),wikiId:i,anchor:n}}},toMarkdown:function(e,t){var i="wiki:"+t.attrs.wikiId;e.write("["+e.esc(t.attrs.label)+"]("+e.esc(i)+' "'+t.attrs.anchor+'")')}}}},registerMarkdownIt:function(e){e.inline.ruler.before("link","wiki",r.createLinkExtension("wiki",{labelAttr:"label",hrefAttr:"wikiId",titleAttr:"title"})),e.renderer.rules.wiki=function(e,t){e=e[t];if(!e.attrGet("label"))return"";t="#"===e.attrGet("wikiId");return c("<div>").append(c("<a>").attr({href:e.attrGet("wikiId"),title:t?a.text("pageNotFound"):e.attrGet("title"),"data-wiki-page":t?"#":""}).text(e.attrGet("label"))).html()}},menu:function(e){return[{id:"wiki",node:"wiki",group:"marks",item:h(e)}]}};e.registerPlugin(n),e.registerPreset("wiki",{extend:"document",callback:function(e){e("wiki","wiki",{before:"link"})}});i=i.extend();a.initOnPjaxLoad=!0,a.export({SearchInput:i,setEditorLink:function(e){var t=s.get("#wikiLinkModal");t.$.trigger("submitted"),t.close()}})}),humhub.module("wiki.History",function(i,e,r){function o(e){r("input[type=radio][name=revision_"+a[e]+"]").prop("checked",!1)}var t=e("ui.widget").Widget,n=e("client"),t=t.extend(),a=[],c="input[type=radio][name^=revision_]";t.prototype.init=function(){r(c).each(function(e){a[e]=r(this).val(),e<2&&r(this).prop("checked",!0)});var t=0,i=1,n="top";this.$.on("click",c,function(){var e=r(c).index(r("[value="+r(this).val()+"]"));"top"===n&&t<e||i<e&&t<e?(o(i),n="bottom",i=e):(o(t),n="top",t=e)})},t.compare=function(){var e=i.config.wikiDiffUrl,t=2;r(c+":checked").each(function(){t&&(e+=-1<e.indexOf("?")?"&":"?",e+="revision"+t+"="+r(this).val(),t--)}),n.pjax.redirect(e)},i.export=t}),function(){var e,c,n,s=function(e){return">"===e},l=function(e){return"<"===e},d=function(e){return/^\s+$/.test(e)},a=function(e){return/^\s*<[^>]+>\s*$/.test(e)},h=function(e){return!a(e)},x=function(e,t,i){this.start_in_before=e,this.start_in_after=t,this.length=i,this.end_in_before=this.start_in_before+this.length-1,this.end_in_after=this.start_in_after+this.length-1},r=function(e){for(var t,i="char",n="",r=[],o=0,a=e.length;o<a;o++)switch(t=e[o],i){case"tag":s(t)?(n+=">",r.push(n),n="",i=d(t)?"whitespace":"char"):n+=t;break;case"char":l(t)?(n&&r.push(n),n="<",i="tag"):/\s/.test(t)?(n&&r.push(n),n=t,i="whitespace"):/[\w\#@]+/i.test(t)?n+=t:(n&&r.push(n),n=t);break;case"whitespace":l(t)?(n&&r.push(n),n="<",i="tag"):d(t)?n+=t:(n&&r.push(n),n=t,i="char");break;default:throw new Error("Unknown mode "+i)}return n&&r.push(n),r},u=function(e,t,i,n,r,o,a){for(var c,s,l,d,h,u,f,p,g,w=n,k=o,_=0,m={},v=c=g=n,b=r;g<=b?c<b:b<c;v=g<=b?++c:--c){for(p={},l=0,d=(h=i[e[v]]).length;l<d;l++)if(!((s=h[l])<o)){if(a<=s)break;null==m[s-1]&&(m[s-1]=0),f=m[s-1]+1,_<(p[s]=f)&&(w=v-f+1,k=s-f+1,_=f)}m=p}return 0!==_&&(u=new x(w,k,_)),u},f=function(e,t,i,n,r,o,a,c){var s;return null!=(s=u(e,0,i,n,r,o,a))&&(n<s.start_in_before&&o<s.start_in_after&&f(e,t,i,n,s.start_in_before,o,s.start_in_after,c),c.push(s),s.end_in_before<=r&&s.end_in_after<=a&&f(e,t,i,s.end_in_before+1,r,s.end_in_after+1,a,c)),c},o=function(e){var t,i,n,r,o,a;if(null==e.find_these)throw new Error("params must have find_these key");if(null==e.in_these)throw new Error("params must have in_these key");for(n={},t=0,r=(o=e.find_these).length;t<r;t++)for(n[a=o[t]]=[],i=e.in_these.indexOf(a);-1!==i;)n[a].push(i),i=e.in_these.indexOf(a,i+1);return n},_=function(e,t){var i=[],n=o({find_these:e,in_these:t});return f(e,t,n,0,e.length,0,t.length,i)},p=function(t,e){var i,n,r,o,a,c,s,l,d,h,u,f,p,g,w,k;if(null==t)throw new Error("before_tokens?");if(null==e)throw new Error("after_tokens?");for(w=g=0,p=[],i={"false,false":"replace","true,false":"insert","false,true":"delete","true,true":"none"},(u=_(t,e)).push(new x(t.length,e.length,0)),o=r=0,l=u.length;r<l;o=++r)"none"!==(n=i[[w===(h=u[o]).start_in_before,g===h.start_in_after].toString()])&&p.push({action:n,start_in_before:w,end_in_before:"insert"!==n?h.start_in_before-1:void 0,start_in_after:g,end_in_after:"delete"!==n?h.start_in_after-1:void 0}),0!==h.length&&p.push({action:"equal",start_in_before:h.start_in_before,end_in_before:h.end_in_before,start_in_after:h.start_in_after,end_in_after:h.end_in_after}),w=h.end_in_before+1,g=h.end_in_after+1;for(k=[],s={action:"none"},a=function(e){return"equal"===e.action&&e.end_in_before-e.start_in_before==0&&/^\s$/.test(t.slice(e.start_in_before,+e.end_in_before+1||9e9))},c=0,d=p.length;c<d;c++)a(f=p[c])&&"replace"===s.action||"replace"===f.action&&"replace"===s.action?(s.end_in_before=f.end_in_before,s.end_in_after=f.end_in_after):(k.push(f),s=f);return k},g=function(e,t,i){for(var n,r,o=void 0,a=r=0,c=(t=t.slice(e,+t.length+1||9e9)).length;r<c&&(!0===(n=i(t[a]))&&(o=a),!1!==n);a=++r);return null!=o?t.slice(0,+o+1||9e9):[]},w=function(e,t){for(var i,n="",r=0,o=t.length;!(o<=r)&&(r+=(i=g(r,t,h)).length,0!==i.length&&(n+="<"+e+">"+i.join("")+"</"+e+">"),!(o<=r));)r+=(i=g(r,t,a)).length,n+=i.join("");return n};(c={equal:function(e,t,i){return t.slice(e.start_in_before,+e.end_in_before+1||9e9).join("")},insert:function(e,t,i){e=i.slice(e.start_in_after,+e.end_in_after+1||9e9);return w("ins",e)},delete:function(e,t,i){e=t.slice(e.start_in_before,+e.end_in_before+1||9e9);return w("del",e)}}).replace=function(e,t,i){return c.delete(e,t,i)+c.insert(e,t,i)},n=function(e,t,i){for(var n,r="",o=0,a=i.length;o<a;o++)n=i[o],r+=c[n.action](n,e,t);return r},(e=function(e,t){var i;return e===t?e:(e=r(e),t=r(t),i=p(e,t),n(e,t,i))}).html_to_tokens=r,(e.find_matching_blocks=_).find_match=u,_.create_index=o,e.calculate_operations=p,e.render_operations=n,"function"==typeof define?define([],function(){return e}):"undefined"!=typeof module&&null!==module?module.exports=e:"undefined"!=typeof window&&(window.htmldiff=e)}();